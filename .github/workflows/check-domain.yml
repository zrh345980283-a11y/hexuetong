name: Verify custom domain (hexuetong.asia) HTTPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for DNS/HTTPS propagation
        run: sleep 20
      - name: Check HTTP redirects to HTTPS
        run: |
          URL="http://hexuetong.asia/"
          CODE=$(curl -sSLI -o /dev/null -w "%{http_code}" "$URL")
          LOC=$(curl -sSLI "$URL" | awk -F': ' '/^Location:/ {print $2}' | tr -d '\r')
          echo "HTTP status: $CODE"
          echo "Location: $LOC"
          case "$CODE" in
            301|302|308) ;;
            *) echo "HTTP does not redirect"; exit 1;;
          esac
          case "$LOC" in
            https://hexuetong.asia/*) ;;
            *) echo "Redirect target is not HTTPS for hexuetong.asia"; exit 1;;
          esac
      - name: Check HTTPS root
        run: |
          URL="https://hexuetong.asia/"
          CODE=$(curl -sSL -o /dev/null -w "%{http_code}" "$URL")
          echo "Root HTTPS status: $CODE"
          if [ "$CODE" != "200" ]; then
            echo "Root page (HTTPS) not ready"; exit 1
          fi
      - name: Check videos over HTTPS
        run: |
          V1="https://hexuetong.asia/video/细胞核的分布及数量.mp4"
          V2="https://hexuetong.asia/video/NB演示伞藻嫁接及核移植实验.mp4"
          for u in "$V1" "$V2"; do
            CODE=$(curl -sSLI -o /dev/null -w "%{http_code}" "$u")
            echo "Video $u status: $CODE"
            case "$CODE" in
              200|206) ;;
              *) echo "Video not accessible over HTTPS: $u"; exit 1;;
            esac
          done
